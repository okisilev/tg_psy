#!/bin/bash

# üîß –û–ë–ù–û–í–õ–ï–ù–ò–ï –°–ò–°–¢–ï–ú–´ –° –ü–û–î–î–ï–†–ñ–ö–û–ô –ö–û–ù–¢–ê–ö–¢–ù–´–• –î–ê–ù–ù–´–•
# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –¥–ª—è —Å–±–æ—Ä–∞ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

echo "üîß –û–ë–ù–û–í–õ–ï–ù–ò–ï –°–ò–°–¢–ï–ú–´ –° –ü–û–î–î–ï–†–ñ–ö–û–ô –ö–û–ù–¢–ê–ö–¢–ù–´–• –î–ê–ù–ù–´–•"
echo "=" * 60

# 1. –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤
echo "‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤..."
pkill -f webhook.py
pkill -f bot.py
sleep 3

# 2. –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π
echo "üíæ –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π..."
cp database.py database.py.backup
cp bot.py bot.py.backup
cp webhook.py webhook.py.backup
cp prodamus.py prodamus.py.backup
echo "   ‚úÖ –†–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏ —Å–æ–∑–¥–∞–Ω—ã"

# 3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
echo "üìù –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ö–µ–º—ã –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."
python3 -c "
from database import Database
db = Database()
print('‚úÖ –°—Ö–µ–º–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∞')
"

# 4. –ó–∞–ø—É—Å–∫ webhook —Å–µ—Ä–≤–µ—Ä–∞
echo "üöÄ –ó–∞–ø—É—Å–∫ webhook —Å–µ—Ä–≤–µ—Ä–∞..."
python3 webhook.py &
WEBHOOK_PID=$!
sleep 3

# 5. –ü—Ä–æ–≤–µ—Ä–∫–∞ webhook
echo "üß™ –ü—Ä–æ–≤–µ—Ä–∫–∞ webhook —Å–µ—Ä–≤–µ—Ä–∞..."
curl -s http://localhost:5000/health

if [ $? -eq 0 ]; then
    echo "   ‚úÖ Webhook —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω (PID: $WEBHOOK_PID)"
else
    echo "   ‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ webhook —Å–µ—Ä–≤–µ—Ä–∞"
    exit 1
fi

# 6. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
echo "üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö..."
python3 test_contact_verification.py

echo ""
echo "üéâ –°–ò–°–¢–ï–ú–ê –ö–û–ù–¢–ê–ö–¢–ù–´–• –î–ê–ù–ù–´–• –û–ë–ù–û–í–õ–ï–ù–ê!"
echo ""
echo "üìù –°—Ç–∞—Ç—É—Å:"
echo "   - Webhook PID: $WEBHOOK_PID"
echo "   - –°–±–æ—Ä –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤: –í–ö–õ–Æ–ß–ï–ù"
echo "   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ –∫–æ–Ω—Ç–∞–∫—Ç–∞–º: –í–ö–õ–Æ–ß–ï–ù–ê"
echo "   - –õ–æ–∫–∞–ª—å–Ω—ã–π URL: http://localhost:5000"
echo ""
echo "üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:"
echo "   python3 test_contact_verification.py"
echo "   python3 test_subscription_activation.py"
echo ""
echo "üìã –õ–æ–≥–∏:"
echo "   tail -f webhook.log"
echo ""
echo "üîß –ù–û–í–´–ï –í–û–ó–ú–û–ñ–ù–û–°–¢–ò:"
echo "   1. –°–±–æ—Ä –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –ø—Ä–∏ –≤—Ö–æ–¥–µ"
echo "   2. –°–±–æ—Ä email –ø—Ä–∏ –≤—Ö–æ–¥–µ"
echo "   3. –ü–µ—Ä–µ–¥–∞—á–∞ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –≤ Prodamus"
echo "   4. –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É/email"
echo "   5. –ü—Ä–∏–≤—è–∑–∫–∞ –ø–ª–∞—Ç–µ–∂–∞ –ø–æ –∫–æ–Ω—Ç–∞–∫—Ç–∞–º"
echo ""
echo "‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏ –æ—Ç–∫–ª—é—á–µ–Ω–∞!"
echo "üîß –≠—Ç–æ –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è"
echo "üìã –ü–æ—Å–ª–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –≤–∫–ª—é—á–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –ø–æ–¥–ø–∏—Å–∏"
echo ""
echo "üíæ –†–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏:"
echo "   - database.py.backup"
echo "   - bot.py.backup"
echo "   - webhook.py.backup"
echo "   - prodamus.py.backup"
echo "üîÑ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ: cp *.backup ."
